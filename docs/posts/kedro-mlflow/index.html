<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jonathan Dekermanjian">
<meta name="dcterms.date" content="2025-04-12">

<title>Reproducibility &amp; Scalability Part 3 MLFlow Integration â€“ Advanced Analytics &amp; Engineering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-fdada01b6a4a613316abf06c0f7ea711.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-0a7893e8d0b037e1aff40777cba0b700.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e7a9757637ee241d0aac7e118435613a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-f03a8ac1726a3c21d0ab9bdd7f9cc648.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Advanced Analytics &amp; Engineering</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Dekermanjian"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="http://www.linkedin.com/in/jonathan-dekermanjian"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Reproducibility &amp; Scalability Part 3<br><sub>MLFlow Integration</sub></h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Engineering</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jonathan Dekermanjian </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 12, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting Started</a></li>
  <li><a href="#setting-up-mlflow" id="toc-setting-up-mlflow" class="nav-link" data-scroll-target="#setting-up-mlflow">Setting up MLFlow</a>
  <ul class="collapse">
  <li><a href="#backend-store" id="toc-backend-store" class="nav-link" data-scroll-target="#backend-store">Backend Store</a></li>
  <li><a href="#artifact-store" id="toc-artifact-store" class="nav-link" data-scroll-target="#artifact-store">Artifact Store</a></li>
  <li><a href="#tracking-server" id="toc-tracking-server" class="nav-link" data-scroll-target="#tracking-server">Tracking Server</a></li>
  <li><a href="#kedro-project-image" id="toc-kedro-project-image" class="nav-link" data-scroll-target="#kedro-project-image">Kedro Project Image</a></li>
  </ul></li>
  <li><a href="#integrating-mlflow" id="toc-integrating-mlflow" class="nav-link" data-scroll-target="#integrating-mlflow">Integrating MLFlow</a>
  <ul class="collapse">
  <li><a href="#kedro-hooks" id="toc-kedro-hooks" class="nav-link" data-scroll-target="#kedro-hooks">Kedro Hooks</a></li>
  <li><a href="#configure-mlflow" id="toc-configure-mlflow" class="nav-link" data-scroll-target="#configure-mlflow">Configure MLFlow</a></li>
  <li><a href="#initialize-mlflow" id="toc-initialize-mlflow" class="nav-link" data-scroll-target="#initialize-mlflow">Initialize MLFlow</a></li>
  <li><a href="#tracking-prior-sampler-configurations" id="toc-tracking-prior-sampler-configurations" class="nav-link" data-scroll-target="#tracking-prior-sampler-configurations">Tracking Prior &amp; Sampler Configurations</a></li>
  <li><a href="#tracking-model-specifications" id="toc-tracking-model-specifications" class="nav-link" data-scroll-target="#tracking-model-specifications">Tracking Model Specifications</a></li>
  <li><a href="#logging-divergences-and-infrence-data-attributes" id="toc-logging-divergences-and-infrence-data-attributes" class="nav-link" data-scroll-target="#logging-divergences-and-infrence-data-attributes">Logging Divergences and Infrence Data Attributes</a></li>
  <li><a href="#logging-metrics" id="toc-logging-metrics" class="nav-link" data-scroll-target="#logging-metrics">Logging Metrics</a></li>
  <li><a href="#saving-a-custom-mlflow-model" id="toc-saving-a-custom-mlflow-model" class="nav-link" data-scroll-target="#saving-a-custom-mlflow-model">Saving a Custom MLFlow Model</a></li>
  </ul></li>
  <li><a href="#experiment-run" id="toc-experiment-run" class="nav-link" data-scroll-target="#experiment-run">Experiment Run</a>
  <ul class="collapse">
  <li><a href="#activating-hooks" id="toc-activating-hooks" class="nav-link" data-scroll-target="#activating-hooks">Activating Hooks</a></li>
  <li><a href="#executing-our-pipeline" id="toc-executing-our-pipeline" class="nav-link" data-scroll-target="#executing-our-pipeline">Executing our pipeline</a></li>
  <li><a href="#parameters-metrics" id="toc-parameters-metrics" class="nav-link" data-scroll-target="#parameters-metrics">Parameters &amp; Metrics</a></li>
  <li><a href="#artifacts" id="toc-artifacts" class="nav-link" data-scroll-target="#artifacts">Artifacts</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#coming-next" id="toc-coming-next" class="nav-link" data-scroll-target="#coming-next">Coming Next</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="overview" class="level1">
<h1>Overview</h1>
<p>In part three of this series, we configure MLFlow for production by defining our tracking server as a containerized PostgreSQL database and our artifact store as containerized MinIO storage. We then integrate MLFlow into our Kedro project in order to start tracking our model development.</p>
</section>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In the previous <a href="../../posts/kedro-pymc-modelbuilder/index.html">post</a> of this series, we configured the <code>ModelBuilder</code> class to add structure to our custom time-series model which in turn enhanced both reproducibility and scalability. In this post, we are going to transition from running our project on our local environment to running inside a containerized environment. In addition, we are going to walkthough setting up <code>MLFlow</code> and its necessary components as containerized services. Finally, we are going to levarge <code>Kedro</code> hooks to track our machine learning experiments with <code>MLFlow</code>.</p>
</section>
<section id="getting-started" class="level1">
<h1>Getting Started</h1>
<p>First thing we need to do is to add <code>MLFlow</code> as a dependency to our <code>environment.yml</code> file. We are also going to need to install <code>psycopg2</code> to allow <code>MLFlow</code> to interact with <code>PostgreSQL</code>.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Depending on what opperating system you are using you may need to install <code>psycopg2-binary</code> intead of <code>psycopg2</code>. In this post we are going to be running everything from inside containers that are running <code>Linux</code>. So we will be using <code>psycopg2-binary</code>.</p>
</div>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> my_environment_name</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">channels</span><span class="kw">:</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> conda-forge</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> defaults</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">'pymc=5.20.1'</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">'graphviz=12.2.1'</span><span class="co"> # New dependency</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">'numpyro=0.17.0'</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">pip</span><span class="kw">:</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> ipython&gt;=8.10</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> jupyterlab&gt;=3.0</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> kedro-datasets&gt;=3.0</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> kedro-viz&gt;=6.7.0</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> kedro[jupyter]~=0.19.11</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> notebook</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> pre-commit~=3.5</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> polars~=1.23.0</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> pyarrow~=18.1.0</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> plotly~=5.24.0</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> openpyxl~=3.1.0</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> kedro-docker~=0.6.2</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> pymc-extras==0.2.3</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> mlflow==2.19.0</span><span class="co"> # New dependency</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> psycopg2-binary==2.9.10</span><span class="co"> # New dependency</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="setting-up-mlflow" class="level1">
<h1>Setting up MLFlow</h1>
<p>Now is a good time to transition from running our pipelines in virtual environments on our machine to running inside of containers. Letâ€™s modify the <code>Dockerfile</code> that we generated in <a href="../../posts/kedro-framework/index.html">part one</a> of this series when we introduced the <code>kedro-docker</code> plugin. We are going to switch from using <code>UV</code> and <code>pip</code> to manage our dependencies when building our image to using <code>Conda</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#./Dockerfile</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> BASE_IMAGE=python:3.9-slim</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> $BASE_IMAGE as runtime-environment</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># install base utils</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="dt">\</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> build-essential <span class="dt">\</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> wget <span class="dt">\</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> git <span class="dt">\</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> clean <span class="dt">\</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># install miniconda</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> CONDA_DIR /opt/conda</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">wget</span> <span class="at">--quiet</span> https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh <span class="at">-O</span> ~/miniconda.sh <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">/bin/bash</span> ~/miniconda.sh <span class="at">-b</span> <span class="at">-p</span> /opt/conda</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># put conda in path</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PATH=$CONDA_DIR/bin:$PATH</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># install project requirements</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> environment.yml /tmp/environment.yml</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">conda</span> env update <span class="at">--name</span> base <span class="at">--file</span> /tmp/environment.yml <span class="at">--prune</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># add kedro user</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> KEDRO_UID=999</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> KEDRO_GID=0</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> <span class="at">-f</span> <span class="at">-g</span> <span class="va">${KEDRO_GID}</span> kedro_group <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="ex">useradd</span> <span class="at">-m</span> <span class="at">-d</span> /home/kedro_docker <span class="at">-s</span> /bin/bash <span class="at">-g</span> <span class="va">${KEDRO_GID}</span> <span class="at">-u</span> <span class="va">${KEDRO_UID}</span> kedro_docker</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/kedro_docker</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="kw">USER</span> kedro_docker</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> runtime-environment</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># copy the whole project except what is in .dockerignore</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> KEDRO_UID=999</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> KEDRO_GID=0</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--chown=${KEDRO_UID}:${KEDRO_GID}</span> . .</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 8888</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"kedro"</span>, <span class="st">"run"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now that our <code>Kedro</code> project can run inside a container letâ€™s configure <code>MLFlow</code>. We will need to configure the following:</p>
<ul>
<li>Define a backend store where metrics, parameters, and metadata are stored</li>
<li>Define an artifact store where large files like models and figures are stored</li>
<li>Define a tracking server that is listening to incoming requests</li>
<li>Allow the server, storage, and our pipelines to communincate with each other</li>
</ul>
<section id="backend-store" class="level2">
<h2 class="anchored" data-anchor-id="backend-store">Backend Store</h2>
<p>As we mentioned earlier, we are going to use PostgreSQL to store our metrics, parameters, and other metadata. In a docker compose file, letâ€™s define our PostgreSQL service. You can name the service however you like; we will name it <code>mlflow-logs</code>. We also need to define a username, password, and database name for our service. We will name our database <code>mlflowdb</code>. We are going to pass in the username and password as an environment variable using secrets. For that you need to make sure you set those variables in your environment. On Linux/MacOS you can set an environment variable like so:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">POSTGRES_USER</span><span class="op">=</span>some_user_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On Windows using PowerShell you can set it like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">$env</span><span class="op">:</span><span class="va">POSTGRES_USER</span> <span class="op">=</span> <span class="st">"some_user_name"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In addition, we need to make sure that what we log into our database persists after the container is brought down. We will define a docker volume and call it <code>pg_mlflow_db</code>. Our <code>docker-compose.yml</code> file looks like this so far:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#./docker-compose.yml</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mlflow-logs</span><span class="kw">:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:16.4</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_USER</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_USER_FILE=/run/secrets/POSTGRES_USER</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD_FILE=/run/secrets/POSTGRES_PASSWORD</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_DB=mlflowdb</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 5432:5432</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> pg_mlflow_db:/var/lib/postgresql/data</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pg_mlflow_db</span><span class="kw">:</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> POSTGRES_USER</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> POSTGRES_PASSWORD</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note how we are using <code>POSTGRES_USER_FILE</code> instead of <code>POSTGRES_USER</code>. This is a convention used by many docker images for passing in secrets.</p>
</div>
</div>
</section>
<section id="artifact-store" class="level2">
<h2 class="anchored" data-anchor-id="artifact-store">Artifact Store</h2>
<p>We need a place to store larger file objects like our models, figures, or artifacts. For that, we are going to define another service in our <code>docker-compose.yml</code> that will host a <code>MinIO</code> S3-compatible object store. Again, we define a username and password like we did before. Letâ€™s also define a default bucket that will be created on creation of the service where we will store our artifacts. Again, like we did for our backend store our artifact store needs a persistant volume. So far we have:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#./docker-compose.yml</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mlflow-logs</span><span class="kw">:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:16.4</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_USER</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_USER_FILE=/run/secrets/POSTGRES_USER</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD_FILE=/run/secrets/POSTGRES_PASSWORD</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_DB=mlflowdb</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 5432:5432</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> pg_mlflow_db:/var/lib/postgresql/data</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">  # New MinIO service</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minio</span><span class="kw">:</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> minio</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">'bitnami/minio:latest'</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">'9000:9000'</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">'9001:9001'</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_ACCESS_KEY_ID</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_ROOT_USER_FILE=/run/secrets/AWS_ACCESS_KEY_ID</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_ROOT_PASSWORD_FILE=/run/secrets/AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_DEFAULT_BUCKETS=mlflow</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> minio_data:/bitnami/minio/data</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pg_mlflow_db</span><span class="kw">:</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minio_data</span><span class="kw">:</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">AWS_ACCESS_KEY_ID</span><span class="kw">:</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> AWS_ACCESS_KEY_ID</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">AWS_SECRET_ACCESS_KEY</span><span class="kw">:</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> POSTGRES_USER</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> POSTGRES_PASSWORD</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tracking-server" class="level2">
<h2 class="anchored" data-anchor-id="tracking-server">Tracking Server</h2>
<p>We are now ready to define the <code>MLFlow</code> tracking-server and configure it so that it can communicate with our backend store and artifact store. The key here is to define the proper environment variables:</p>
<ul>
<li><b>MLFLOW_BACKEND_STORE_URI</b>: This will point to our PostgreSQL service which has the form <code>postgresql://username:password@service_name:port/database_name</code></li>
<li><b>MLFLOW_ARTIFACTS_DESTINATION</b>: This will point to our storage bucket which has the form <code>s3://bucket_name</code></li>
<li><b>MLFLOW_S3_ENDPOINT_URL</b>: This will point to our MinIO service and which the form <code>http://service_name:port</code></li>
<li><b>AWS_ACCESS_KEY_ID</b>: This is the access key ID to our MinIO service. It can be the root user (not recommended) or bucket specific access key</li>
<li><b>AWS_SECRET_ACCESS_KEY</b>: This is the secret access key ID to our MinIO service. It can be the root password (not recommended) or bucket specific secret access key</li>
</ul>
<p>Letâ€™s go ahead and add our tracking-server service to our compose file:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#./docker-compose.yml</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mlflow-logs</span><span class="kw">:</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:16.4</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_USER</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_USER_FILE=/run/secrets/POSTGRES_USER</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD_FILE=/run/secrets/POSTGRES_PASSWORD</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_DB=mlflowdb</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 5432:5432</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> pg_mlflow_db:/var/lib/postgresql/data</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minio</span><span class="kw">:</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> minio</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">'bitnami/minio:latest'</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">'9000:9000'</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">'9001:9001'</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_ACCESS_KEY_ID</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_ROOT_USER_FILE=/run/secrets/AWS_ACCESS_KEY_ID</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_ROOT_PASSWORD_FILE=/run/secrets/AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_DEFAULT_BUCKETS=mlflow</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> minio_data:/bitnami/minio/data</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co">  # new tracking server service</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mlflow-tracking-server</span><span class="kw">:</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/mlflow/mlflow:v2.19.0</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="fu">    command</span><span class="kw">: </span><span class="ch">&gt;</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>      bash -c "</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>          pip install -U pip</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>          pip install psycopg2-binary boto3</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>          mlflow server --host 0.0.0.0 --port 5000 --workers 1</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>      "</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 5050:5000</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_BACKEND_STORE_URI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@mlflow-logs:5432/mlflowdb</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_ARTIFACTS_DESTINATION=s3://mlflow</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_S3_ENDPOINT_URL=http://minio:9000</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_S3_IGNORE_TLS=true</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_ACCESS_KEY_ID</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> minio</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> mlflow-logs</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">stop_grace_period</span><span class="kw">:</span><span class="at"> 1s</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pg_mlflow_db</span><span class="kw">:</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minio_data</span><span class="kw">:</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">AWS_ACCESS_KEY_ID</span><span class="kw">:</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> AWS_ACCESS_KEY_ID</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">AWS_SECRET_ACCESS_KEY</span><span class="kw">:</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> POSTGRES_USER</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> POSTGRES_PASSWORD</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Environment variables that arenâ€™t passed in using the /run/secrets method can be viewed by echoing that variable in the containerâ€™s shell!</p>
</div>
</div>
</section>
<section id="kedro-project-image" class="level2">
<h2 class="anchored" data-anchor-id="kedro-project-image">Kedro Project Image</h2>
<p>The final service we will be adding in this section is the image of our <code>Kedro</code> project. We set a profile of manual on this service so that the container isnâ€™t brought up automatically. We do this because it is likely that you want this service to run on a schedule so we just let the scheduler handle bringing the service up. Notice that we set the environment variable <code>MLFLOW_TRACKING_URI</code> to the service name and port that is running our <code>MLFlow</code> tracking server. This will allow us to communicate from our Kedro project service.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#./docker-compose.yml</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mlflow-logs</span><span class="kw">:</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> postgres:16.4</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_USER</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_USER_FILE=/run/secrets/POSTGRES_USER</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_PASSWORD_FILE=/run/secrets/POSTGRES_PASSWORD</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> POSTGRES_DB=mlflowdb</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 5432:5432</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> pg_mlflow_db:/var/lib/postgresql/data</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minio</span><span class="kw">:</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container_name</span><span class="kw">:</span><span class="at"> minio</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">'bitnami/minio:latest'</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">'9000:9000'</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">'9001:9001'</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_ACCESS_KEY_ID</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_ROOT_USER_FILE=/run/secrets/AWS_ACCESS_KEY_ID</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_ROOT_PASSWORD_FILE=/run/secrets/AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MINIO_DEFAULT_BUCKETS=mlflow</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> minio_data:/bitnami/minio/data</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">mlflow-tracking-server</span><span class="kw">:</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> ghcr.io/mlflow/mlflow:v2.19.0</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="fu">    command</span><span class="kw">: </span><span class="ch">&gt;</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        bash -c "</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>            pip install -U pip</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            pip install psycopg2-binary boto3</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            mlflow server --host 0.0.0.0 --port 5000 --workers 1</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        "</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> 5050:5000</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_BACKEND_STORE_URI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@mlflow-logs:5432/mlflowdb</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_ARTIFACTS_DESTINATION=s3://mlflow</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_S3_ENDPOINT_URL=http://minio:9000</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_S3_IGNORE_TLS=true</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_ACCESS_KEY_ID</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> minio</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> mlflow-logs</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">stop_grace_period</span><span class="kw">:</span><span class="at"> 1s</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co">  # New service added</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">climate-brazil</span><span class="kw">:</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">profiles</span><span class="kw">:</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> manual</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span><span class="at"> .</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> MLFLOW_TRACKING_URI=http://mlflow-tracking-server:5000</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> mlflow-tracking-server</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> minio</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> mlflow-logs</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pg_mlflow_db</span><span class="kw">:</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minio_data</span><span class="kw">:</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="fu">secrets</span><span class="kw">:</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">AWS_ACCESS_KEY_ID</span><span class="kw">:</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> AWS_ACCESS_KEY_ID</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">AWS_SECRET_ACCESS_KEY</span><span class="kw">:</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> AWS_SECRET_ACCESS_KEY</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">POSTGRES_USER</span><span class="kw">:</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> POSTGRES_USER</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">POSTGRES_PASSWORD</span><span class="kw">:</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> POSTGRES_PASSWORD</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="integrating-mlflow" class="level1">
<h1>Integrating MLFlow</h1>
<p>Now that we have our services defined we need to modify our <code>Kedro</code> project to interact with the <code>MLFlow</code> tracking server. For that we are going to introduce hooks; another useful <code>Kedro</code> feature.</p>
<section id="kedro-hooks" class="level2">
<h2 class="anchored" data-anchor-id="kedro-hooks">Kedro Hooks</h2>
<p>Hooks are a great way to add additional functionality to your pipelines at specific points during, before or after execution. Common use cases of hooks are:</p>
<ul>
<li>Injecting additional logging behavior before/after pipeline/node execution</li>
<li>Validating input data is in the correct format before executing a node</li>
<li>Debugging a node/pipeline</li>
<li>Tracking/Profiling resource utilization</li>
<li>Customizing load and save methods</li>
</ul>
<p>We are going to use hooks to inject additional logging and customize saving methods by logging metrics and parameters, and saving models/artifacts using <code>MLFlow</code>.</p>
<p>To define hooks in <code>Kedro</code> we need to create a new file <code>hooks.py</code> inside of <code>/src/climate_brazil/</code> and create a class that will contain our hookâ€™s logic as itâ€™s methods. The scaffolding will look like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /src/climate_brazil/hooks.py</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kedro.framework.hooks <span class="im">import</span> hook_impl</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelTrackingHooks:</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@hook_impl</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_node_run(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, node: Node, outputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any], inputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any]</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@hook_impl</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_pipeline_run(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A lot of times you donâ€™t actually need to define a <code>__init__()</code> method for you hook class. We will define it in our use case so that we can initialize <code>MLFlow</code>.</p>
</div>
</div>
</section>
<section id="configure-mlflow" class="level2">
<h2 class="anchored" data-anchor-id="configure-mlflow">Configure MLFlow</h2>
<p>Before we start experiment tracking with <code>MLFlow</code>, letâ€™s set up some configuration variables inside of <code>conf/base/parameters_ML.yml</code>. First, letâ€™s have the option to either use or not use <code>MLFlow</code>. Second, artifact logging can use up quite a bit of storage, so letâ€™s make that optional as well. Finally, letâ€™s set an experiment name and tags that will help differentiate experiment runs.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yml code-with-copy"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#conf/base/parameters_ML.yml</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mlflow_config</span><span class="kw">:</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">use_mlflow</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">log_artifacts</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">experiment_name</span><span class="kw">:</span><span class="at"> climate-brazil</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tags</span><span class="kw">:</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">model</span><span class="kw">:</span><span class="at"> structural time-series</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">trend_component</span><span class="kw">:</span><span class="at"> Gaussian Process</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">seasonal_component</span><span class="kw">:</span><span class="at"> Fourier</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="initialize-mlflow" class="level2">
<h2 class="anchored" data-anchor-id="initialize-mlflow">Initialize MLFlow</h2>
<p>Now we need to initialze <code>MLFlow</code> whenever we start a run of our pipeline. As a reminder we are going to do that using the <code>Kedro</code> hook we defined scaffolding for earlier.</p>
<div class="sourceCode" id="annotated-cell-11"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /src/climate_brazil/hooks.py</span></span>
<span id="annotated-cell-11-2"><a href="#annotated-cell-11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="annotated-cell-11-3"><a href="#annotated-cell-11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-4"><a href="#annotated-cell-11-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kedro.framework.hooks <span class="im">import</span> hook_impl</span>
<span id="annotated-cell-11-5"><a href="#annotated-cell-11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-6"><a href="#annotated-cell-11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelTrackingHooks:</span>
<span id="annotated-cell-11-7"><a href="#annotated-cell-11-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-11-8" class="code-annotation-target"><a href="#annotated-cell-11-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_ids <span class="op">=</span> {}</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-11-9" class="code-annotation-target"><a href="#annotated-cell-11-9" aria-hidden="true" tabindex="-1"></a>        conf_path <span class="op">=</span> <span class="st">"./conf"</span></span>
<span id="annotated-cell-11-10"><a href="#annotated-cell-11-10" aria-hidden="true" tabindex="-1"></a>        conf_loader <span class="op">=</span> OmegaConfigLoader(conf_source<span class="op">=</span>conf_path)</span>
<span id="annotated-cell-11-11"><a href="#annotated-cell-11-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.params <span class="op">=</span> conf_loader.get(<span class="st">'parameters'</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-11-12" class="code-annotation-target"><a href="#annotated-cell-11-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-11-13"><a href="#annotated-cell-11-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># set the experiment and start an MLFlow run</span></span>
<span id="annotated-cell-11-14"><a href="#annotated-cell-11-14" aria-hidden="true" tabindex="-1"></a>            mlflow.set_experiment(</span>
<span id="annotated-cell-11-15"><a href="#annotated-cell-11-15" aria-hidden="true" tabindex="-1"></a>                experiment_name<span class="op">=</span><span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'experiment_name'</span>]</span>
<span id="annotated-cell-11-16"><a href="#annotated-cell-11-16" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-11-17"><a href="#annotated-cell-11-17" aria-hidden="true" tabindex="-1"></a>            mlflow.start_run()</span>
<span id="annotated-cell-11-18"><a href="#annotated-cell-11-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the run ID so that we can nest in the individual city models</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-11-19" class="code-annotation-target"><a href="#annotated-cell-11-19" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.run_ids[<span class="st">"parent_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-11-20"><a href="#annotated-cell-11-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If you have tags set for the run set them in MLFlow</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-11-21" class="code-annotation-target"><a href="#annotated-cell-11-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>]:</span>
<span id="annotated-cell-11-22"><a href="#annotated-cell-11-22" aria-hidden="true" tabindex="-1"></a>                mlflow.set_tags(<span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>])</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="8" data-code-annotation="1">Initialize a dictionary to store run IDs</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="9,10,11" data-code-annotation="2">Load configurations we defined from inside our parameters files</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="12,14,15,16,17" data-code-annotation="3">If we are using <code>MLFlow</code> set the experiment name we defined and start a run</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="19" data-code-annotation="4">Store the run ID inside the dictionary object we initialized earlier</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="21,22" data-code-annotation="5">If tags are defined set them to the current run</span>
</dd>
</dl>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can click on the above circled numbers to highlight the corresponding lines in the code cell directly above them.</p>
</div>
</div>
</section>
<section id="tracking-prior-sampler-configurations" class="level2">
<h2 class="anchored" data-anchor-id="tracking-prior-sampler-configurations">Tracking Prior &amp; Sampler Configurations</h2>
<p>As soon as we start an <code>MLFlow</code> run we can start logging the parameters for our priors and our sampler configurations that we defined in <code>/conf/base/parameters_ML.yml</code>. Letâ€™s go ahead and log those with <code>MLFlow</code> inside our <code>__init__()</code> method:</p>
<div class="sourceCode" id="annotated-cell-12"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-12-1"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /src/climate_brazil/hooks.py</span></span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="annotated-cell-12-3"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-4"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="annotated-cell-12-5"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kedro.framework.hooks <span class="im">import</span> hook_impl</span>
<span id="annotated-cell-12-6"><a href="#annotated-cell-12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-7"><a href="#annotated-cell-12-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelTrackingHooks:</span>
<span id="annotated-cell-12-8"><a href="#annotated-cell-12-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="annotated-cell-12-9"><a href="#annotated-cell-12-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_ids <span class="op">=</span> {}</span>
<span id="annotated-cell-12-10"><a href="#annotated-cell-12-10" aria-hidden="true" tabindex="-1"></a>        conf_path <span class="op">=</span> <span class="st">"./conf"</span></span>
<span id="annotated-cell-12-11"><a href="#annotated-cell-12-11" aria-hidden="true" tabindex="-1"></a>        conf_loader <span class="op">=</span> OmegaConfigLoader(conf_source<span class="op">=</span>conf_path)</span>
<span id="annotated-cell-12-12"><a href="#annotated-cell-12-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.params <span class="op">=</span> conf_loader.get(<span class="st">'parameters'</span>)</span>
<span id="annotated-cell-12-13"><a href="#annotated-cell-12-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-12-14"><a href="#annotated-cell-12-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># set the experiment and start an MLFlow run</span></span>
<span id="annotated-cell-12-15"><a href="#annotated-cell-12-15" aria-hidden="true" tabindex="-1"></a>            mlflow.set_experiment(</span>
<span id="annotated-cell-12-16"><a href="#annotated-cell-12-16" aria-hidden="true" tabindex="-1"></a>                experiment_name<span class="op">=</span><span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'experiment_name'</span>]</span>
<span id="annotated-cell-12-17"><a href="#annotated-cell-12-17" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-12-18"><a href="#annotated-cell-12-18" aria-hidden="true" tabindex="-1"></a>            mlflow.start_run()</span>
<span id="annotated-cell-12-19"><a href="#annotated-cell-12-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the run ID so that we can nest in the individual city models</span></span>
<span id="annotated-cell-12-20"><a href="#annotated-cell-12-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.run_ids[<span class="st">"parent_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-12-21"><a href="#annotated-cell-12-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We can log our model and sampler configs early</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-12-22" class="code-annotation-target"><a href="#annotated-cell-12-22" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'model_config'</span>])</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-12-23" class="code-annotation-target"><a href="#annotated-cell-12-23" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'sampler_config'</span>])</span>
<span id="annotated-cell-12-24"><a href="#annotated-cell-12-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If you have tags set for the run set them in MLFlow</span></span>
<span id="annotated-cell-12-25"><a href="#annotated-cell-12-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>]:</span>
<span id="annotated-cell-12-26"><a href="#annotated-cell-12-26" aria-hidden="true" tabindex="-1"></a>                mlflow.set_tags(<span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>])</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="22" data-code-annotation="1">We log our model configuration, which if you recall, holds the parameters for our priors</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="23" data-code-annotation="2">Here we log our sampler configurations. This is useful to log for when we have divergences, our sampling is slow, or when our effective sampling size is too small.</span>
</dd>
</dl>
</section>
<section id="tracking-model-specifications" class="level2">
<h2 class="anchored" data-anchor-id="tracking-model-specifications">Tracking Model Specifications</h2>
<p>PyMC allows you to plot a graphical representation of the model using GraphViz. These plots can facilitate comparing different model specifications across experiment runs without needing to read through code. So, we will generate these figures and log them as artifacts. Itâ€™s also a good idea to define one run of our experiment as running through all of the cities. So, we will create nested runs for each city within our top-level parent run.</p>
<div class="sourceCode" id="annotated-cell-13"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-13-1"><a href="#annotated-cell-13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /src/climate_brazil/hooks.py</span></span>
<span id="annotated-cell-13-2"><a href="#annotated-cell-13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="annotated-cell-13-3"><a href="#annotated-cell-13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-4"><a href="#annotated-cell-13-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="annotated-cell-13-5"><a href="#annotated-cell-13-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kedro.framework.hooks <span class="im">import</span> hook_impl</span>
<span id="annotated-cell-13-6"><a href="#annotated-cell-13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-7"><a href="#annotated-cell-13-7" aria-hidden="true" tabindex="-1"></a>cities <span class="op">=</span> [</span>
<span id="annotated-cell-13-8"><a href="#annotated-cell-13-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Belem"</span>, <span class="st">"Curitiba"</span>, <span class="st">"Fortaleza"</span>, <span class="st">"Goiania"</span>, <span class="st">"Macapa"</span>, <span class="st">"Manaus"</span>, </span>
<span id="annotated-cell-13-9"><a href="#annotated-cell-13-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Recife"</span>, <span class="st">"Rio"</span>, <span class="st">"Salvador"</span>, <span class="st">"Sao_Luiz"</span>, <span class="st">"Sao_Paulo"</span>, <span class="st">"Vitoria"</span></span>
<span id="annotated-cell-13-10"><a href="#annotated-cell-13-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="annotated-cell-13-11"><a href="#annotated-cell-13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-12"><a href="#annotated-cell-13-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelTrackingHooks:</span>
<span id="annotated-cell-13-13"><a href="#annotated-cell-13-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="annotated-cell-13-14"><a href="#annotated-cell-13-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_ids <span class="op">=</span> {}</span>
<span id="annotated-cell-13-15"><a href="#annotated-cell-13-15" aria-hidden="true" tabindex="-1"></a>        conf_path <span class="op">=</span> <span class="st">"./conf"</span></span>
<span id="annotated-cell-13-16"><a href="#annotated-cell-13-16" aria-hidden="true" tabindex="-1"></a>        conf_loader <span class="op">=</span> OmegaConfigLoader(conf_source<span class="op">=</span>conf_path)</span>
<span id="annotated-cell-13-17"><a href="#annotated-cell-13-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.params <span class="op">=</span> conf_loader.get(<span class="st">'parameters'</span>)</span>
<span id="annotated-cell-13-18"><a href="#annotated-cell-13-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-13-19"><a href="#annotated-cell-13-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># set the experiment and start an MLFlow run</span></span>
<span id="annotated-cell-13-20"><a href="#annotated-cell-13-20" aria-hidden="true" tabindex="-1"></a>            mlflow.set_experiment(</span>
<span id="annotated-cell-13-21"><a href="#annotated-cell-13-21" aria-hidden="true" tabindex="-1"></a>                experiment_name<span class="op">=</span><span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'experiment_name'</span>]</span>
<span id="annotated-cell-13-22"><a href="#annotated-cell-13-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-13-23"><a href="#annotated-cell-13-23" aria-hidden="true" tabindex="-1"></a>            mlflow.start_run()</span>
<span id="annotated-cell-13-24"><a href="#annotated-cell-13-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the run ID so that we can nest in the individual city models</span></span>
<span id="annotated-cell-13-25"><a href="#annotated-cell-13-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.run_ids[<span class="st">"parent_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-13-26"><a href="#annotated-cell-13-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We can log our model and sampler configs early</span></span>
<span id="annotated-cell-13-27"><a href="#annotated-cell-13-27" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'model_config'</span>])</span>
<span id="annotated-cell-13-28"><a href="#annotated-cell-13-28" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'sampler_config'</span>])</span>
<span id="annotated-cell-13-29"><a href="#annotated-cell-13-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If you have tags set for the run set them in MLFlow</span></span>
<span id="annotated-cell-13-30"><a href="#annotated-cell-13-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>]:</span>
<span id="annotated-cell-13-31"><a href="#annotated-cell-13-31" aria-hidden="true" tabindex="-1"></a>                mlflow.set_tags(<span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>])</span>
<span id="annotated-cell-13-32"><a href="#annotated-cell-13-32" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-13-33" class="code-annotation-target"><a href="#annotated-cell-13-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@hook_impl</span></span>
<span id="annotated-cell-13-34"><a href="#annotated-cell-13-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_node_run(</span>
<span id="annotated-cell-13-35"><a href="#annotated-cell-13-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, node: Node, outputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any], inputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any]</span>
<span id="annotated-cell-13-36"><a href="#annotated-cell-13-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="annotated-cell-13-37"><a href="#annotated-cell-13-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="annotated-cell-13-38"><a href="#annotated-cell-13-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Here we are going to pull outputs from specific nodes and log them with MLFlow</span></span>
<span id="annotated-cell-13-39"><a href="#annotated-cell-13-39" aria-hidden="true" tabindex="-1"></a><span class="co">        ---</span></span>
<span id="annotated-cell-13-40"><a href="#annotated-cell-13-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Params:</span></span>
<span id="annotated-cell-13-41"><a href="#annotated-cell-13-41" aria-hidden="true" tabindex="-1"></a><span class="co">            node: Attributes of the node that just ran</span></span>
<span id="annotated-cell-13-42"><a href="#annotated-cell-13-42" aria-hidden="true" tabindex="-1"></a><span class="co">            outputs: Outputs of the node that just ran</span></span>
<span id="annotated-cell-13-43"><a href="#annotated-cell-13-43" aria-hidden="true" tabindex="-1"></a><span class="co">            inputes: Inputes of the node that just ran</span></span>
<span id="annotated-cell-13-44"><a href="#annotated-cell-13-44" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-13-45" class="code-annotation-target"><a href="#annotated-cell-13-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.name <span class="op">==</span> <span class="st">"train"</span>:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-13-46" class="code-annotation-target"><a href="#annotated-cell-13-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> city <span class="kw">in</span> cities:</span>
<span id="annotated-cell-13-47"><a href="#annotated-cell-13-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-13-48"><a href="#annotated-cell-13-48" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Start a nested run</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-13-49" class="code-annotation-target"><a href="#annotated-cell-13-49" aria-hidden="true" tabindex="-1"></a>                    mlflow.start_run(</span>
<span id="annotated-cell-13-50"><a href="#annotated-cell-13-50" aria-hidden="true" tabindex="-1"></a>                        run_name<span class="op">=</span>city,</span>
<span id="annotated-cell-13-51"><a href="#annotated-cell-13-51" aria-hidden="true" tabindex="-1"></a>                        nested<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-13-52"><a href="#annotated-cell-13-52" aria-hidden="true" tabindex="-1"></a>                        parent_run_id<span class="op">=</span><span class="va">self</span>.run_ids[<span class="st">'parent_run_id'</span>]</span>
<span id="annotated-cell-13-53"><a href="#annotated-cell-13-53" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="annotated-cell-13-54"><a href="#annotated-cell-13-54" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Store city specific run ids for later</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-13-55" class="code-annotation-target"><a href="#annotated-cell-13-55" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.run_ids[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-13-56"><a href="#annotated-cell-13-56" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># If you want to log artifacts log them here</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-13-57" class="code-annotation-target"><a href="#annotated-cell-13-57" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'log_artifacts'</span>]:</span>
<span id="annotated-cell-13-58"><a href="#annotated-cell-13-58" aria-hidden="true" tabindex="-1"></a>                        local_path <span class="op">=</span> <span class="ss">f"./data/08_reporting/</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model_graph.png"</span></span>
<span id="annotated-cell-13-59"><a href="#annotated-cell-13-59" aria-hidden="true" tabindex="-1"></a>                        outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>].model.to_graphviz(</span>
<span id="annotated-cell-13-60"><a href="#annotated-cell-13-60" aria-hidden="true" tabindex="-1"></a>                            save<span class="op">=</span>local_path, </span>
<span id="annotated-cell-13-61"><a href="#annotated-cell-13-61" aria-hidden="true" tabindex="-1"></a>                            figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">8</span>)</span>
<span id="annotated-cell-13-62"><a href="#annotated-cell-13-62" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="annotated-cell-13-63"><a href="#annotated-cell-13-63" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># log graph representation of model</span></span>
<span id="annotated-cell-13-64"><a href="#annotated-cell-13-64" aria-hidden="true" tabindex="-1"></a>                        mlflow.log_artifact(local_path<span class="op">=</span>local_path, artifact_path<span class="op">=</span><span class="st">"figures"</span>)</span>
<span id="annotated-cell-13-65"><a href="#annotated-cell-13-65" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Define the inputs the model expects when forecasting</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-13-66" class="code-annotation-target"><a href="#annotated-cell-13-66" aria-hidden="true" tabindex="-1"></a>                    mlflow.end_run()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="33,34,35,36" data-code-annotation="1">Define a hook that will run after a <code>Kedro</code> node completes execution.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="45" data-code-annotation="2">If the node that completes is named <code>train</code> then fire the hook.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="46" data-code-annotation="3">For each city prepare to log city specific attributes.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="49,50,51,52,53" data-code-annotation="4">Start a nested run within our current active run.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="55" data-code-annotation="5">Store the nested run ID.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="57,58,62,64" data-code-annotation="6">Create the graphical representation of the model and log it as an artifact in our artifact store under the directory of <code>figures/</code></span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="66" data-code-annotation="7">Close the active nested run.</span>
</dd>
</dl>
</section>
<section id="logging-divergences-and-infrence-data-attributes" class="level2">
<h2 class="anchored" data-anchor-id="logging-divergences-and-infrence-data-attributes">Logging Divergences and Infrence Data Attributes</h2>
<p>It is also useful to log any divergences you come across during sampling because as you fit more and more models it can be difficult to keep track of any sampling problems. We will also log our Inference Data attributes which will include the model ID that <code>ModelBuilder</code> gives a new instance of our model, the city name, and the mean and standard deviation of our average temperatures for each city.</p>
<div class="sourceCode" id="annotated-cell-14"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-14-1"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /src/climate_brazil/hooks.py</span></span>
<span id="annotated-cell-14-2"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="annotated-cell-14-3"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kedro.framework.hooks <span class="im">import</span> hook_impl</span>
<span id="annotated-cell-14-6"><a href="#annotated-cell-14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-7"><a href="#annotated-cell-14-7" aria-hidden="true" tabindex="-1"></a>cities <span class="op">=</span> [</span>
<span id="annotated-cell-14-8"><a href="#annotated-cell-14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Belem"</span>, <span class="st">"Curitiba"</span>, <span class="st">"Fortaleza"</span>, <span class="st">"Goiania"</span>, <span class="st">"Macapa"</span>, <span class="st">"Manaus"</span>, </span>
<span id="annotated-cell-14-9"><a href="#annotated-cell-14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Recife"</span>, <span class="st">"Rio"</span>, <span class="st">"Salvador"</span>, <span class="st">"Sao_Luiz"</span>, <span class="st">"Sao_Paulo"</span>, <span class="st">"Vitoria"</span></span>
<span id="annotated-cell-14-10"><a href="#annotated-cell-14-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="annotated-cell-14-11"><a href="#annotated-cell-14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-12"><a href="#annotated-cell-14-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelTrackingHooks:</span>
<span id="annotated-cell-14-13"><a href="#annotated-cell-14-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="annotated-cell-14-14"><a href="#annotated-cell-14-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_ids <span class="op">=</span> {}</span>
<span id="annotated-cell-14-15"><a href="#annotated-cell-14-15" aria-hidden="true" tabindex="-1"></a>        conf_path <span class="op">=</span> <span class="st">"./conf"</span></span>
<span id="annotated-cell-14-16"><a href="#annotated-cell-14-16" aria-hidden="true" tabindex="-1"></a>        conf_loader <span class="op">=</span> OmegaConfigLoader(conf_source<span class="op">=</span>conf_path)</span>
<span id="annotated-cell-14-17"><a href="#annotated-cell-14-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.params <span class="op">=</span> conf_loader.get(<span class="st">'parameters'</span>)</span>
<span id="annotated-cell-14-18"><a href="#annotated-cell-14-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-14-19"><a href="#annotated-cell-14-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># set the experiment and start an MLFlow run</span></span>
<span id="annotated-cell-14-20"><a href="#annotated-cell-14-20" aria-hidden="true" tabindex="-1"></a>            mlflow.set_experiment(</span>
<span id="annotated-cell-14-21"><a href="#annotated-cell-14-21" aria-hidden="true" tabindex="-1"></a>                experiment_name<span class="op">=</span><span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'experiment_name'</span>]</span>
<span id="annotated-cell-14-22"><a href="#annotated-cell-14-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-14-23"><a href="#annotated-cell-14-23" aria-hidden="true" tabindex="-1"></a>            mlflow.start_run()</span>
<span id="annotated-cell-14-24"><a href="#annotated-cell-14-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the run ID so that we can nest in the individual city models</span></span>
<span id="annotated-cell-14-25"><a href="#annotated-cell-14-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.run_ids[<span class="st">"parent_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-14-26"><a href="#annotated-cell-14-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We can log our model and sampler configs early</span></span>
<span id="annotated-cell-14-27"><a href="#annotated-cell-14-27" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'model_config'</span>])</span>
<span id="annotated-cell-14-28"><a href="#annotated-cell-14-28" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'sampler_config'</span>])</span>
<span id="annotated-cell-14-29"><a href="#annotated-cell-14-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If you have tags set for the run set them in MLFlow</span></span>
<span id="annotated-cell-14-30"><a href="#annotated-cell-14-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>]:</span>
<span id="annotated-cell-14-31"><a href="#annotated-cell-14-31" aria-hidden="true" tabindex="-1"></a>                mlflow.set_tags(<span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>])</span>
<span id="annotated-cell-14-32"><a href="#annotated-cell-14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-33"><a href="#annotated-cell-14-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@hook_impl</span></span>
<span id="annotated-cell-14-34"><a href="#annotated-cell-14-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_node_run(</span>
<span id="annotated-cell-14-35"><a href="#annotated-cell-14-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, node: Node, outputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any], inputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any]</span>
<span id="annotated-cell-14-36"><a href="#annotated-cell-14-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="annotated-cell-14-37"><a href="#annotated-cell-14-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="annotated-cell-14-38"><a href="#annotated-cell-14-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Here we are going to pull outputs from specific nodes and log them with MLFlow</span></span>
<span id="annotated-cell-14-39"><a href="#annotated-cell-14-39" aria-hidden="true" tabindex="-1"></a><span class="co">        ---</span></span>
<span id="annotated-cell-14-40"><a href="#annotated-cell-14-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Params:</span></span>
<span id="annotated-cell-14-41"><a href="#annotated-cell-14-41" aria-hidden="true" tabindex="-1"></a><span class="co">            node: Attributes of the node that just ran</span></span>
<span id="annotated-cell-14-42"><a href="#annotated-cell-14-42" aria-hidden="true" tabindex="-1"></a><span class="co">            outputs: Outputs of the node that just ran</span></span>
<span id="annotated-cell-14-43"><a href="#annotated-cell-14-43" aria-hidden="true" tabindex="-1"></a><span class="co">            inputes: Inputes of the node that just ran</span></span>
<span id="annotated-cell-14-44"><a href="#annotated-cell-14-44" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="annotated-cell-14-45"><a href="#annotated-cell-14-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.name <span class="op">==</span> <span class="st">"train"</span>:</span>
<span id="annotated-cell-14-46"><a href="#annotated-cell-14-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> city <span class="kw">in</span> cities:</span>
<span id="annotated-cell-14-47"><a href="#annotated-cell-14-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-14-48"><a href="#annotated-cell-14-48" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Start a nested run</span></span>
<span id="annotated-cell-14-49"><a href="#annotated-cell-14-49" aria-hidden="true" tabindex="-1"></a>                    mlflow.start_run(</span>
<span id="annotated-cell-14-50"><a href="#annotated-cell-14-50" aria-hidden="true" tabindex="-1"></a>                        run_name<span class="op">=</span>city, </span>
<span id="annotated-cell-14-51"><a href="#annotated-cell-14-51" aria-hidden="true" tabindex="-1"></a>                        nested<span class="op">=</span><span class="va">True</span>, </span>
<span id="annotated-cell-14-52"><a href="#annotated-cell-14-52" aria-hidden="true" tabindex="-1"></a>                        parent_run_id<span class="op">=</span><span class="va">self</span>.run_ids[<span class="st">'parent_run_id'</span>]</span>
<span id="annotated-cell-14-53"><a href="#annotated-cell-14-53" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="annotated-cell-14-54"><a href="#annotated-cell-14-54" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Store city specific run ids for later</span></span>
<span id="annotated-cell-14-55"><a href="#annotated-cell-14-55" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.run_ids[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-14-56"><a href="#annotated-cell-14-56" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># If you want to log artifacts log them here</span></span>
<span id="annotated-cell-14-57"><a href="#annotated-cell-14-57" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'log_artifacts'</span>]:</span>
<span id="annotated-cell-14-58"><a href="#annotated-cell-14-58" aria-hidden="true" tabindex="-1"></a>                        local_path <span class="op">=</span> <span class="ss">f"./data/08_reporting/</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model_graph.png"</span></span>
<span id="annotated-cell-14-59"><a href="#annotated-cell-14-59" aria-hidden="true" tabindex="-1"></a>                        outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>].model.to_graphviz(</span>
<span id="annotated-cell-14-60"><a href="#annotated-cell-14-60" aria-hidden="true" tabindex="-1"></a>                            save<span class="op">=</span>local_path, </span>
<span id="annotated-cell-14-61"><a href="#annotated-cell-14-61" aria-hidden="true" tabindex="-1"></a>                            figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">8</span>)</span>
<span id="annotated-cell-14-62"><a href="#annotated-cell-14-62" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="annotated-cell-14-63"><a href="#annotated-cell-14-63" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># log graph representation of model</span></span>
<span id="annotated-cell-14-64"><a href="#annotated-cell-14-64" aria-hidden="true" tabindex="-1"></a>                        mlflow.log_artifact(local_path<span class="op">=</span>local_path, artifact_path<span class="op">=</span><span class="st">"figures"</span>)</span>
<span id="annotated-cell-14-65"><a href="#annotated-cell-14-65" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># log divergences and inference data attributes</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-14-66" class="code-annotation-target"><a href="#annotated-cell-14-66" aria-hidden="true" tabindex="-1"></a>                    mlflow.log_param(</span>
<span id="annotated-cell-14-67"><a href="#annotated-cell-14-67" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"divergences"</span>,</span>
<span id="annotated-cell-14-68"><a href="#annotated-cell-14-68" aria-hidden="true" tabindex="-1"></a>                        (</span>
<span id="annotated-cell-14-69"><a href="#annotated-cell-14-69" aria-hidden="true" tabindex="-1"></a>                            outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>]</span>
<span id="annotated-cell-14-70"><a href="#annotated-cell-14-70" aria-hidden="true" tabindex="-1"></a>                              .idata.sample_stats.diverging.<span class="bu">sum</span>()</span>
<span id="annotated-cell-14-71"><a href="#annotated-cell-14-71" aria-hidden="true" tabindex="-1"></a>                              .values.item()</span>
<span id="annotated-cell-14-72"><a href="#annotated-cell-14-72" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="annotated-cell-14-73"><a href="#annotated-cell-14-73" aria-hidden="true" tabindex="-1"></a>                    )</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-14-74" class="code-annotation-target"><a href="#annotated-cell-14-74" aria-hidden="true" tabindex="-1"></a>                    mlflow.log_params(outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>].idata.attrs)</span>
<span id="annotated-cell-14-75"><a href="#annotated-cell-14-75" aria-hidden="true" tabindex="-1"></a>                    mlflow.end_run()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="66,67,68,69,70,71,72,73" data-code-annotation="1">Log divergences if any occured during sampling.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="74" data-code-annotation="2">Log Inference Data attributes.</span>
</dd>
</dl>
</section>
<section id="logging-metrics" class="level2">
<h2 class="anchored" data-anchor-id="logging-metrics">Logging Metrics</h2>
<p>Obviously, we would want to log some metrics that give us an indication of how well our model is performing. In the previous post, we decided to evaluate our model using the root mean square error (RMSE) and the 80% Highest Density Interval (HDI) coverage. Letâ€™s go ahead and log those metrics.</p>
<div class="sourceCode" id="annotated-cell-15"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-15-1"><a href="#annotated-cell-15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /src/climate_brazil/hooks.py</span></span>
<span id="annotated-cell-15-2"><a href="#annotated-cell-15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="annotated-cell-15-3"><a href="#annotated-cell-15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-4"><a href="#annotated-cell-15-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="annotated-cell-15-5"><a href="#annotated-cell-15-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kedro.framework.hooks <span class="im">import</span> hook_impl</span>
<span id="annotated-cell-15-6"><a href="#annotated-cell-15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-7"><a href="#annotated-cell-15-7" aria-hidden="true" tabindex="-1"></a>cities <span class="op">=</span> [</span>
<span id="annotated-cell-15-8"><a href="#annotated-cell-15-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Belem"</span>, <span class="st">"Curitiba"</span>, <span class="st">"Fortaleza"</span>, <span class="st">"Goiania"</span>, <span class="st">"Macapa"</span>, <span class="st">"Manaus"</span>, </span>
<span id="annotated-cell-15-9"><a href="#annotated-cell-15-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Recife"</span>, <span class="st">"Rio"</span>, <span class="st">"Salvador"</span>, <span class="st">"Sao_Luiz"</span>, <span class="st">"Sao_Paulo"</span>, <span class="st">"Vitoria"</span></span>
<span id="annotated-cell-15-10"><a href="#annotated-cell-15-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="annotated-cell-15-11"><a href="#annotated-cell-15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-12"><a href="#annotated-cell-15-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelTrackingHooks:</span>
<span id="annotated-cell-15-13"><a href="#annotated-cell-15-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="annotated-cell-15-14"><a href="#annotated-cell-15-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_ids <span class="op">=</span> {}</span>
<span id="annotated-cell-15-15"><a href="#annotated-cell-15-15" aria-hidden="true" tabindex="-1"></a>        conf_path <span class="op">=</span> <span class="st">"./conf"</span></span>
<span id="annotated-cell-15-16"><a href="#annotated-cell-15-16" aria-hidden="true" tabindex="-1"></a>        conf_loader <span class="op">=</span> OmegaConfigLoader(conf_source<span class="op">=</span>conf_path)</span>
<span id="annotated-cell-15-17"><a href="#annotated-cell-15-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.params <span class="op">=</span> conf_loader.get(<span class="st">'parameters'</span>)</span>
<span id="annotated-cell-15-18"><a href="#annotated-cell-15-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-15-19"><a href="#annotated-cell-15-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># set the experiment and start an MLFlow run</span></span>
<span id="annotated-cell-15-20"><a href="#annotated-cell-15-20" aria-hidden="true" tabindex="-1"></a>            mlflow.set_experiment(</span>
<span id="annotated-cell-15-21"><a href="#annotated-cell-15-21" aria-hidden="true" tabindex="-1"></a>                experiment_name<span class="op">=</span><span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'experiment_name'</span>]</span>
<span id="annotated-cell-15-22"><a href="#annotated-cell-15-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-15-23"><a href="#annotated-cell-15-23" aria-hidden="true" tabindex="-1"></a>            mlflow.start_run()</span>
<span id="annotated-cell-15-24"><a href="#annotated-cell-15-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the run ID so that we can nest in the individual city models</span></span>
<span id="annotated-cell-15-25"><a href="#annotated-cell-15-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.run_ids[<span class="st">"parent_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-15-26"><a href="#annotated-cell-15-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We can log our model and sampler configs early</span></span>
<span id="annotated-cell-15-27"><a href="#annotated-cell-15-27" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'model_config'</span>])</span>
<span id="annotated-cell-15-28"><a href="#annotated-cell-15-28" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'sampler_config'</span>])</span>
<span id="annotated-cell-15-29"><a href="#annotated-cell-15-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If you have tags set for the run set them in MLFlow</span></span>
<span id="annotated-cell-15-30"><a href="#annotated-cell-15-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>]:</span>
<span id="annotated-cell-15-31"><a href="#annotated-cell-15-31" aria-hidden="true" tabindex="-1"></a>                mlflow.set_tags(<span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>])</span>
<span id="annotated-cell-15-32"><a href="#annotated-cell-15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-33"><a href="#annotated-cell-15-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@hook_impl</span></span>
<span id="annotated-cell-15-34"><a href="#annotated-cell-15-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_node_run(</span>
<span id="annotated-cell-15-35"><a href="#annotated-cell-15-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, node: Node, outputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any], inputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any]</span>
<span id="annotated-cell-15-36"><a href="#annotated-cell-15-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="annotated-cell-15-37"><a href="#annotated-cell-15-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="annotated-cell-15-38"><a href="#annotated-cell-15-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Here we are going to pull outputs from specific nodes and log them with MLFlow</span></span>
<span id="annotated-cell-15-39"><a href="#annotated-cell-15-39" aria-hidden="true" tabindex="-1"></a><span class="co">        ---</span></span>
<span id="annotated-cell-15-40"><a href="#annotated-cell-15-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Params:</span></span>
<span id="annotated-cell-15-41"><a href="#annotated-cell-15-41" aria-hidden="true" tabindex="-1"></a><span class="co">            node: Attributes of the node that just ran</span></span>
<span id="annotated-cell-15-42"><a href="#annotated-cell-15-42" aria-hidden="true" tabindex="-1"></a><span class="co">            outputs: Outputs of the node that just ran</span></span>
<span id="annotated-cell-15-43"><a href="#annotated-cell-15-43" aria-hidden="true" tabindex="-1"></a><span class="co">            inputes: Inputes of the node that just ran</span></span>
<span id="annotated-cell-15-44"><a href="#annotated-cell-15-44" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="annotated-cell-15-45"><a href="#annotated-cell-15-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.name <span class="op">==</span> <span class="st">"train"</span>:</span>
<span id="annotated-cell-15-46"><a href="#annotated-cell-15-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> city <span class="kw">in</span> cities:</span>
<span id="annotated-cell-15-47"><a href="#annotated-cell-15-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-15-48"><a href="#annotated-cell-15-48" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Start a nested run</span></span>
<span id="annotated-cell-15-49"><a href="#annotated-cell-15-49" aria-hidden="true" tabindex="-1"></a>                    mlflow.start_run(</span>
<span id="annotated-cell-15-50"><a href="#annotated-cell-15-50" aria-hidden="true" tabindex="-1"></a>                        run_name<span class="op">=</span>city, </span>
<span id="annotated-cell-15-51"><a href="#annotated-cell-15-51" aria-hidden="true" tabindex="-1"></a>                        nested<span class="op">=</span><span class="va">True</span>, </span>
<span id="annotated-cell-15-52"><a href="#annotated-cell-15-52" aria-hidden="true" tabindex="-1"></a>                        parent_run_id<span class="op">=</span><span class="va">self</span>.run_ids[<span class="st">'parent_run_id'</span>]</span>
<span id="annotated-cell-15-53"><a href="#annotated-cell-15-53" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="annotated-cell-15-54"><a href="#annotated-cell-15-54" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Store city specific run ids for later</span></span>
<span id="annotated-cell-15-55"><a href="#annotated-cell-15-55" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.run_ids[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-15-56"><a href="#annotated-cell-15-56" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># If you want to log artifacts log them here</span></span>
<span id="annotated-cell-15-57"><a href="#annotated-cell-15-57" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'log_artifacts'</span>]:</span>
<span id="annotated-cell-15-58"><a href="#annotated-cell-15-58" aria-hidden="true" tabindex="-1"></a>                        local_path <span class="op">=</span> <span class="ss">f"./data/08_reporting/</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model_graph.png"</span></span>
<span id="annotated-cell-15-59"><a href="#annotated-cell-15-59" aria-hidden="true" tabindex="-1"></a>                        outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>].model.to_graphviz(</span>
<span id="annotated-cell-15-60"><a href="#annotated-cell-15-60" aria-hidden="true" tabindex="-1"></a>                            save<span class="op">=</span>local_path, </span>
<span id="annotated-cell-15-61"><a href="#annotated-cell-15-61" aria-hidden="true" tabindex="-1"></a>                            figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">8</span>)</span>
<span id="annotated-cell-15-62"><a href="#annotated-cell-15-62" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="annotated-cell-15-63"><a href="#annotated-cell-15-63" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># log graph representation of model</span></span>
<span id="annotated-cell-15-64"><a href="#annotated-cell-15-64" aria-hidden="true" tabindex="-1"></a>                        mlflow.log_artifact(local_path<span class="op">=</span>local_path, artifact_path<span class="op">=</span><span class="st">"figures"</span>)</span>
<span id="annotated-cell-15-65"><a href="#annotated-cell-15-65" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># log divergences and inference data attributes</span></span>
<span id="annotated-cell-15-66"><a href="#annotated-cell-15-66" aria-hidden="true" tabindex="-1"></a>                    mlflow.log_param(</span>
<span id="annotated-cell-15-67"><a href="#annotated-cell-15-67" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"divergences"</span>, </span>
<span id="annotated-cell-15-68"><a href="#annotated-cell-15-68" aria-hidden="true" tabindex="-1"></a>                        (</span>
<span id="annotated-cell-15-69"><a href="#annotated-cell-15-69" aria-hidden="true" tabindex="-1"></a>                            outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>]</span>
<span id="annotated-cell-15-70"><a href="#annotated-cell-15-70" aria-hidden="true" tabindex="-1"></a>                              .idata.sample_stats.diverging.<span class="bu">sum</span>()</span>
<span id="annotated-cell-15-71"><a href="#annotated-cell-15-71" aria-hidden="true" tabindex="-1"></a>                              .values.item()</span>
<span id="annotated-cell-15-72"><a href="#annotated-cell-15-72" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="annotated-cell-15-73"><a href="#annotated-cell-15-73" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="annotated-cell-15-74"><a href="#annotated-cell-15-74" aria-hidden="true" tabindex="-1"></a>                    mlflow.log_params(outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>].idata.attrs)</span>
<span id="annotated-cell-15-75"><a href="#annotated-cell-15-75" aria-hidden="true" tabindex="-1"></a>                    mlflow.end_run()</span>
<span id="annotated-cell-15-76"><a href="#annotated-cell-15-76" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-15-77" class="code-annotation-target"><a href="#annotated-cell-15-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.name <span class="kw">in</span> [<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_forecasts_evaluation"</span> <span class="cf">for</span> city <span class="kw">in</span> cities]:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-15-78" class="code-annotation-target"><a href="#annotated-cell-15-78" aria-hidden="true" tabindex="-1"></a>            city <span class="op">=</span> re.search(<span class="vs">r"(.*)(?=_forecasts_evaluation)"</span>, node.name).group(<span class="dv">1</span>)</span>
<span id="annotated-cell-15-79"><a href="#annotated-cell-15-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]: </span>
<span id="annotated-cell-15-80"><a href="#annotated-cell-15-80" aria-hidden="true" tabindex="-1"></a>                <span class="co"># start up again our city specific runs to log metrics</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-15-81" class="code-annotation-target"><a href="#annotated-cell-15-81" aria-hidden="true" tabindex="-1"></a>                mlflow.start_run(</span>
<span id="annotated-cell-15-82"><a href="#annotated-cell-15-82" aria-hidden="true" tabindex="-1"></a>                    run_id<span class="op">=</span><span class="va">self</span>.run_ids[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_run_id"</span>],</span>
<span id="annotated-cell-15-83"><a href="#annotated-cell-15-83" aria-hidden="true" tabindex="-1"></a>                    run_name<span class="op">=</span>city,</span>
<span id="annotated-cell-15-84"><a href="#annotated-cell-15-84" aria-hidden="true" tabindex="-1"></a>                    nested<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-15-85"><a href="#annotated-cell-15-85" aria-hidden="true" tabindex="-1"></a>                    parent_run_id<span class="op">=</span><span class="va">self</span>.run_ids[<span class="st">'parent_run_id'</span>]</span>
<span id="annotated-cell-15-86"><a href="#annotated-cell-15-86" aria-hidden="true" tabindex="-1"></a>                )</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-15-87" class="code-annotation-target"><a href="#annotated-cell-15-87" aria-hidden="true" tabindex="-1"></a>                mlflow.log_metrics(outputs[<span class="ss">f'</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_evaluation'</span>])</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-15-88" class="code-annotation-target"><a href="#annotated-cell-15-88" aria-hidden="true" tabindex="-1"></a>                mlflow.end_run()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="77" data-code-annotation="1">Execute the hook only if the node corresponds to our evaluation nodes.</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="78" data-code-annotation="2">Grab the city name using Regex.</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="81,82,83,84,85" data-code-annotation="3">Re-activate the nested run corresponding to the city.</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="87" data-code-annotation="4">Log the RMSE and coverage metrics</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="88" data-code-annotation="5">Close the nested city run again.</span>
</dd>
</dl>
</section>
<section id="saving-a-custom-mlflow-model" class="level2">
<h2 class="anchored" data-anchor-id="saving-a-custom-mlflow-model">Saving a Custom MLFlow Model</h2>
<p><code>MLFlow</code> has several flavors of model frameworks already built-in that allow you to save your trained model into an easily deployable <code>MLFlow</code> model object. Behind the scenes <code>MLFlow</code> defines how the model should be loaded and how predictions are to be made using the model. Since we have built a custom solution using the Probabilistic Programming Language (PPL) <code>PyMC</code> we need to tell <code>MLFlow</code> how to load and use our model during forecasting time.</p>
<div class="sourceCode" id="annotated-cell-16"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-16-1"><a href="#annotated-cell-16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># src/climate_brazil/pipelines/ML/mlflow_model_wrapper.py</span></span>
<span id="annotated-cell-16-2"><a href="#annotated-cell-16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="annotated-cell-16-3"><a href="#annotated-cell-16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-16-4"><a href="#annotated-cell-16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlflow.pyfunc <span class="im">import</span> Context, PythonModel</span>
<span id="annotated-cell-16-5"><a href="#annotated-cell-16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-16-6"><a href="#annotated-cell-16-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kedro_framework.pipelines.ML.ts_model <span class="im">import</span> TSModel</span>
<span id="annotated-cell-16-7"><a href="#annotated-cell-16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-16-8"><a href="#annotated-cell-16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PyMCModelWrapper(PythonModel):</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-16-9" class="code-annotation-target"><a href="#annotated-cell-16-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_context(<span class="va">self</span>, context: Context) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="annotated-cell-16-10"><a href="#annotated-cell-16-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="annotated-cell-16-11"><a href="#annotated-cell-16-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Loads the trained model from the given context.</span></span>
<span id="annotated-cell-16-12"><a href="#annotated-cell-16-12" aria-hidden="true" tabindex="-1"></a><span class="co">        ---</span></span>
<span id="annotated-cell-16-13"><a href="#annotated-cell-16-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Params:</span></span>
<span id="annotated-cell-16-14"><a href="#annotated-cell-16-14" aria-hidden="true" tabindex="-1"></a><span class="co">            context: The context object containing artifacts, including the model.</span></span>
<span id="annotated-cell-16-15"><a href="#annotated-cell-16-15" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="annotated-cell-16-16"><a href="#annotated-cell-16-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> TSModel.load(context.artifacts[<span class="st">'model'</span>])</span>
<span id="annotated-cell-16-17"><a href="#annotated-cell-16-17" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-16-18" class="code-annotation-target"><a href="#annotated-cell-16-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, context: Context, n_ahead: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="annotated-cell-16-19"><a href="#annotated-cell-16-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="annotated-cell-16-20"><a href="#annotated-cell-16-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Makes predictions using the model for the specified number of time steps ahead.</span></span>
<span id="annotated-cell-16-21"><a href="#annotated-cell-16-21" aria-hidden="true" tabindex="-1"></a><span class="co">        ---</span></span>
<span id="annotated-cell-16-22"><a href="#annotated-cell-16-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Params:</span></span>
<span id="annotated-cell-16-23"><a href="#annotated-cell-16-23" aria-hidden="true" tabindex="-1"></a><span class="co">            context: The context object containing artifacts, including the model.</span></span>
<span id="annotated-cell-16-24"><a href="#annotated-cell-16-24" aria-hidden="true" tabindex="-1"></a><span class="co">            n_ahead: The number of future time steps to predict.</span></span>
<span id="annotated-cell-16-25"><a href="#annotated-cell-16-25" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="annotated-cell-16-26"><a href="#annotated-cell-16-26" aria-hidden="true" tabindex="-1"></a>        preds_normalized <span class="op">=</span> <span class="va">self</span>.model.sample_posterior_predictive(</span>
<span id="annotated-cell-16-27"><a href="#annotated-cell-16-27" aria-hidden="true" tabindex="-1"></a>            n_ahead<span class="op">=</span>n_ahead.iloc[:, <span class="dv">0</span>].values.item(), </span>
<span id="annotated-cell-16-28"><a href="#annotated-cell-16-28" aria-hidden="true" tabindex="-1"></a>            extend_idata<span class="op">=</span><span class="va">False</span>, </span>
<span id="annotated-cell-16-29"><a href="#annotated-cell-16-29" aria-hidden="true" tabindex="-1"></a>            combined<span class="op">=</span><span class="va">False</span></span>
<span id="annotated-cell-16-30"><a href="#annotated-cell-16-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-16-31"><a href="#annotated-cell-16-31" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> preds_normalized <span class="op">*</span> <span class="va">self</span>.model.idata.attrs[<span class="st">'y_std'</span>] <span class="op">+</span> </span>
<span id="annotated-cell-16-32"><a href="#annotated-cell-16-32" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.model.idata.attrs[<span class="st">'y_mean'</span>]</span>
<span id="annotated-cell-16-33"><a href="#annotated-cell-16-33" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> preds.rename_vars(</span>
<span id="annotated-cell-16-34"><a href="#annotated-cell-16-34" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"temperature_normalized_fut"</span>: <span class="st">"temperature_fut"</span>}</span>
<span id="annotated-cell-16-35"><a href="#annotated-cell-16-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="annotated-cell-16-36"><a href="#annotated-cell-16-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json.dumps(preds.to_dataframe().reset_index().to_dict(<span class="st">'records'</span>))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-16" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="9" data-code-annotation="1">Load the trained model</span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="18" data-code-annotation="2">Generate forecasts using the trained model</span>
</dd>
</dl>
<p>Now that we can log our model with <code>MLFlow</code> letâ€™s add that logic to our hook:</p>
<div class="sourceCode" id="annotated-cell-17"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-17-1"><a href="#annotated-cell-17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /src/climate_brazil/hooks.py</span></span>
<span id="annotated-cell-17-2"><a href="#annotated-cell-17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any</span>
<span id="annotated-cell-17-3"><a href="#annotated-cell-17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-4"><a href="#annotated-cell-17-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="annotated-cell-17-5"><a href="#annotated-cell-17-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> kedro.framework.hooks <span class="im">import</span> hook_impl</span>
<span id="annotated-cell-17-6"><a href="#annotated-cell-17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-7"><a href="#annotated-cell-17-7" aria-hidden="true" tabindex="-1"></a>cities <span class="op">=</span> [</span>
<span id="annotated-cell-17-8"><a href="#annotated-cell-17-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Belem"</span>, <span class="st">"Curitiba"</span>, <span class="st">"Fortaleza"</span>, <span class="st">"Goiania"</span>, <span class="st">"Macapa"</span>, <span class="st">"Manaus"</span>, </span>
<span id="annotated-cell-17-9"><a href="#annotated-cell-17-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Recife"</span>, <span class="st">"Rio"</span>, <span class="st">"Salvador"</span>, <span class="st">"Sao_Luiz"</span>, <span class="st">"Sao_Paulo"</span>, <span class="st">"Vitoria"</span></span>
<span id="annotated-cell-17-10"><a href="#annotated-cell-17-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="annotated-cell-17-11"><a href="#annotated-cell-17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-12"><a href="#annotated-cell-17-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelTrackingHooks:</span>
<span id="annotated-cell-17-13"><a href="#annotated-cell-17-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="annotated-cell-17-14"><a href="#annotated-cell-17-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.run_ids <span class="op">=</span> {}</span>
<span id="annotated-cell-17-15"><a href="#annotated-cell-17-15" aria-hidden="true" tabindex="-1"></a>        conf_path <span class="op">=</span> <span class="st">"./conf"</span></span>
<span id="annotated-cell-17-16"><a href="#annotated-cell-17-16" aria-hidden="true" tabindex="-1"></a>        conf_loader <span class="op">=</span> OmegaConfigLoader(conf_source<span class="op">=</span>conf_path)</span>
<span id="annotated-cell-17-17"><a href="#annotated-cell-17-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.params <span class="op">=</span> conf_loader.get(<span class="st">'parameters'</span>)</span>
<span id="annotated-cell-17-18"><a href="#annotated-cell-17-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-17-19"><a href="#annotated-cell-17-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># set the experiment and start an MLFlow run</span></span>
<span id="annotated-cell-17-20"><a href="#annotated-cell-17-20" aria-hidden="true" tabindex="-1"></a>            mlflow.set_experiment(</span>
<span id="annotated-cell-17-21"><a href="#annotated-cell-17-21" aria-hidden="true" tabindex="-1"></a>                experiment_name<span class="op">=</span><span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'experiment_name'</span>]</span>
<span id="annotated-cell-17-22"><a href="#annotated-cell-17-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="annotated-cell-17-23"><a href="#annotated-cell-17-23" aria-hidden="true" tabindex="-1"></a>            mlflow.start_run()</span>
<span id="annotated-cell-17-24"><a href="#annotated-cell-17-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the run ID so that we can nest in the individual city models</span></span>
<span id="annotated-cell-17-25"><a href="#annotated-cell-17-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.run_ids[<span class="st">"parent_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-17-26"><a href="#annotated-cell-17-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We can log our model and sampler configs early</span></span>
<span id="annotated-cell-17-27"><a href="#annotated-cell-17-27" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'model_config'</span>])</span>
<span id="annotated-cell-17-28"><a href="#annotated-cell-17-28" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(<span class="va">self</span>.params[<span class="st">'sampler_config'</span>])</span>
<span id="annotated-cell-17-29"><a href="#annotated-cell-17-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If you have tags set for the run set them in MLFlow</span></span>
<span id="annotated-cell-17-30"><a href="#annotated-cell-17-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>]:</span>
<span id="annotated-cell-17-31"><a href="#annotated-cell-17-31" aria-hidden="true" tabindex="-1"></a>                mlflow.set_tags(<span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'tags'</span>])</span>
<span id="annotated-cell-17-32"><a href="#annotated-cell-17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-33"><a href="#annotated-cell-17-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@hook_impl</span></span>
<span id="annotated-cell-17-34"><a href="#annotated-cell-17-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_node_run(</span>
<span id="annotated-cell-17-35"><a href="#annotated-cell-17-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, node: Node, outputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any], inputs: <span class="bu">dict</span>[<span class="bu">str</span>, Any]</span>
<span id="annotated-cell-17-36"><a href="#annotated-cell-17-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="annotated-cell-17-37"><a href="#annotated-cell-17-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="annotated-cell-17-38"><a href="#annotated-cell-17-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Here we are going to pull outputs from specific nodes and log them with MLFlow</span></span>
<span id="annotated-cell-17-39"><a href="#annotated-cell-17-39" aria-hidden="true" tabindex="-1"></a><span class="co">        ---</span></span>
<span id="annotated-cell-17-40"><a href="#annotated-cell-17-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Params:</span></span>
<span id="annotated-cell-17-41"><a href="#annotated-cell-17-41" aria-hidden="true" tabindex="-1"></a><span class="co">            node: Attributes of the node that just ran</span></span>
<span id="annotated-cell-17-42"><a href="#annotated-cell-17-42" aria-hidden="true" tabindex="-1"></a><span class="co">            outputs: Outputs of the node that just ran</span></span>
<span id="annotated-cell-17-43"><a href="#annotated-cell-17-43" aria-hidden="true" tabindex="-1"></a><span class="co">            inputes: Inputes of the node that just ran</span></span>
<span id="annotated-cell-17-44"><a href="#annotated-cell-17-44" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="annotated-cell-17-45"><a href="#annotated-cell-17-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.name <span class="op">==</span> <span class="st">"train"</span>:</span>
<span id="annotated-cell-17-46"><a href="#annotated-cell-17-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> city <span class="kw">in</span> cities:</span>
<span id="annotated-cell-17-47"><a href="#annotated-cell-17-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]:</span>
<span id="annotated-cell-17-48"><a href="#annotated-cell-17-48" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Start a nested run</span></span>
<span id="annotated-cell-17-49"><a href="#annotated-cell-17-49" aria-hidden="true" tabindex="-1"></a>                    mlflow.start_run(</span>
<span id="annotated-cell-17-50"><a href="#annotated-cell-17-50" aria-hidden="true" tabindex="-1"></a>                        run_name<span class="op">=</span>city, </span>
<span id="annotated-cell-17-51"><a href="#annotated-cell-17-51" aria-hidden="true" tabindex="-1"></a>                        nested<span class="op">=</span><span class="va">True</span>, </span>
<span id="annotated-cell-17-52"><a href="#annotated-cell-17-52" aria-hidden="true" tabindex="-1"></a>                        parent_run_id<span class="op">=</span><span class="va">self</span>.run_ids[<span class="st">'parent_run_id'</span>]</span>
<span id="annotated-cell-17-53"><a href="#annotated-cell-17-53" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="annotated-cell-17-54"><a href="#annotated-cell-17-54" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Store city specific run ids for later</span></span>
<span id="annotated-cell-17-55"><a href="#annotated-cell-17-55" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.run_ids[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_run_id"</span>] <span class="op">=</span> mlflow.active_run().info.run_id</span>
<span id="annotated-cell-17-56"><a href="#annotated-cell-17-56" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># If you want to log artifacts log them here</span></span>
<span id="annotated-cell-17-57"><a href="#annotated-cell-17-57" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'log_artifacts'</span>]:</span>
<span id="annotated-cell-17-58"><a href="#annotated-cell-17-58" aria-hidden="true" tabindex="-1"></a>                        local_path <span class="op">=</span> <span class="ss">f"./data/08_reporting/</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model_graph.png"</span></span>
<span id="annotated-cell-17-59"><a href="#annotated-cell-17-59" aria-hidden="true" tabindex="-1"></a>                        outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>].model.to_graphviz(</span>
<span id="annotated-cell-17-60"><a href="#annotated-cell-17-60" aria-hidden="true" tabindex="-1"></a>                            save<span class="op">=</span>local_path, </span>
<span id="annotated-cell-17-61"><a href="#annotated-cell-17-61" aria-hidden="true" tabindex="-1"></a>                            figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">8</span>)</span>
<span id="annotated-cell-17-62"><a href="#annotated-cell-17-62" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="annotated-cell-17-63"><a href="#annotated-cell-17-63" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># log graph representation of model</span></span>
<span id="annotated-cell-17-64"><a href="#annotated-cell-17-64" aria-hidden="true" tabindex="-1"></a>                        mlflow.log_artifact(local_path<span class="op">=</span>local_path, artifact_path<span class="op">=</span><span class="st">"figures"</span>)</span>
<span id="annotated-cell-17-65"><a href="#annotated-cell-17-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-66"><a href="#annotated-cell-17-66" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Define the inputs the model expects when forecasting</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-17-67" class="code-annotation-target"><a href="#annotated-cell-17-67" aria-hidden="true" tabindex="-1"></a>                        input_schema <span class="op">=</span> mlflow.types.Schema(</span>
<span id="annotated-cell-17-68"><a href="#annotated-cell-17-68" aria-hidden="true" tabindex="-1"></a>                            [</span>
<span id="annotated-cell-17-69"><a href="#annotated-cell-17-69" aria-hidden="true" tabindex="-1"></a>                                mlflow.types.ColSpec(</span>
<span id="annotated-cell-17-70"><a href="#annotated-cell-17-70" aria-hidden="true" tabindex="-1"></a>                                    name<span class="op">=</span><span class="st">"n_ahead"</span>,</span>
<span id="annotated-cell-17-71"><a href="#annotated-cell-17-71" aria-hidden="true" tabindex="-1"></a>                                    <span class="bu">type</span><span class="op">=</span>mlflow.types.DataType.integer</span>
<span id="annotated-cell-17-72"><a href="#annotated-cell-17-72" aria-hidden="true" tabindex="-1"></a>                                ),</span>
<span id="annotated-cell-17-73"><a href="#annotated-cell-17-73" aria-hidden="true" tabindex="-1"></a>                            ]</span>
<span id="annotated-cell-17-74"><a href="#annotated-cell-17-74" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="annotated-cell-17-75"><a href="#annotated-cell-17-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-76"><a href="#annotated-cell-17-76" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Log the model</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-17-77" class="code-annotation-target"><a href="#annotated-cell-17-77" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">with</span> tempfile.TemporaryDirectory() <span class="im">as</span> tmpdir:</span>
<span id="annotated-cell-17-78"><a href="#annotated-cell-17-78" aria-hidden="true" tabindex="-1"></a>                            file_path <span class="op">=</span> os.path.join(tmpdir, <span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model.nc"</span>)</span>
<span id="annotated-cell-17-79"><a href="#annotated-cell-17-79" aria-hidden="true" tabindex="-1"></a>                            outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>].save(file_path)</span>
<span id="annotated-cell-17-80"><a href="#annotated-cell-17-80" aria-hidden="true" tabindex="-1"></a>                            mlflow.pyfunc.log_model(</span>
<span id="annotated-cell-17-81"><a href="#annotated-cell-17-81" aria-hidden="true" tabindex="-1"></a>                                artifact_path<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="annotated-cell-17-82"><a href="#annotated-cell-17-82" aria-hidden="true" tabindex="-1"></a>                                python_model<span class="op">=</span>PyMCModelWrapper(),</span>
<span id="annotated-cell-17-83"><a href="#annotated-cell-17-83" aria-hidden="true" tabindex="-1"></a>                                artifacts<span class="op">=</span>{<span class="st">"model"</span>: file_path},</span>
<span id="annotated-cell-17-84"><a href="#annotated-cell-17-84" aria-hidden="true" tabindex="-1"></a>                                signature<span class="op">=</span>ModelSignature(inputs<span class="op">=</span>input_schema),</span>
<span id="annotated-cell-17-85"><a href="#annotated-cell-17-85" aria-hidden="true" tabindex="-1"></a>                                conda_env<span class="op">=</span><span class="st">"./environment.yml"</span></span>
<span id="annotated-cell-17-86"><a href="#annotated-cell-17-86" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="annotated-cell-17-87"><a href="#annotated-cell-17-87" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># log divergences and inference data attributes</span></span>
<span id="annotated-cell-17-88"><a href="#annotated-cell-17-88" aria-hidden="true" tabindex="-1"></a>                    mlflow.log_param(</span>
<span id="annotated-cell-17-89"><a href="#annotated-cell-17-89" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"divergences"</span>, </span>
<span id="annotated-cell-17-90"><a href="#annotated-cell-17-90" aria-hidden="true" tabindex="-1"></a>                        (</span>
<span id="annotated-cell-17-91"><a href="#annotated-cell-17-91" aria-hidden="true" tabindex="-1"></a>                            outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>]</span>
<span id="annotated-cell-17-92"><a href="#annotated-cell-17-92" aria-hidden="true" tabindex="-1"></a>                              .idata.sample_stats.diverging.<span class="bu">sum</span>()</span>
<span id="annotated-cell-17-93"><a href="#annotated-cell-17-93" aria-hidden="true" tabindex="-1"></a>                              .values.item()</span>
<span id="annotated-cell-17-94"><a href="#annotated-cell-17-94" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="annotated-cell-17-95"><a href="#annotated-cell-17-95" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="annotated-cell-17-96"><a href="#annotated-cell-17-96" aria-hidden="true" tabindex="-1"></a>                    mlflow.log_params(outputs[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_model"</span>].idata.attrs)</span>
<span id="annotated-cell-17-97"><a href="#annotated-cell-17-97" aria-hidden="true" tabindex="-1"></a>                    mlflow.end_run()</span>
<span id="annotated-cell-17-98"><a href="#annotated-cell-17-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-99"><a href="#annotated-cell-17-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node.name <span class="kw">in</span> [<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_forecasts_evaluation"</span> <span class="cf">for</span> city <span class="kw">in</span> cities]:</span>
<span id="annotated-cell-17-100"><a href="#annotated-cell-17-100" aria-hidden="true" tabindex="-1"></a>            city <span class="op">=</span> re.search(<span class="vs">r"(.*)(?=_forecasts_evaluation)"</span>, node.name).group(<span class="dv">1</span>)</span>
<span id="annotated-cell-17-101"><a href="#annotated-cell-17-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.params[<span class="st">'mlflow_config'</span>][<span class="st">'use_mlflow'</span>]: </span>
<span id="annotated-cell-17-102"><a href="#annotated-cell-17-102" aria-hidden="true" tabindex="-1"></a>                <span class="co"># start up again our city specific runs to log metrics</span></span>
<span id="annotated-cell-17-103"><a href="#annotated-cell-17-103" aria-hidden="true" tabindex="-1"></a>                mlflow.start_run(</span>
<span id="annotated-cell-17-104"><a href="#annotated-cell-17-104" aria-hidden="true" tabindex="-1"></a>                    run_id<span class="op">=</span><span class="va">self</span>.run_ids[<span class="ss">f"</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_run_id"</span>],</span>
<span id="annotated-cell-17-105"><a href="#annotated-cell-17-105" aria-hidden="true" tabindex="-1"></a>                    run_name<span class="op">=</span>city,</span>
<span id="annotated-cell-17-106"><a href="#annotated-cell-17-106" aria-hidden="true" tabindex="-1"></a>                    nested<span class="op">=</span><span class="va">True</span>,</span>
<span id="annotated-cell-17-107"><a href="#annotated-cell-17-107" aria-hidden="true" tabindex="-1"></a>                    parent_run_id<span class="op">=</span><span class="va">self</span>.run_ids[<span class="st">'parent_run_id'</span>]</span>
<span id="annotated-cell-17-108"><a href="#annotated-cell-17-108" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="annotated-cell-17-109"><a href="#annotated-cell-17-109" aria-hidden="true" tabindex="-1"></a>                mlflow.log_metrics(outputs[<span class="ss">f'</span><span class="sc">{</span>city<span class="sc">}</span><span class="ss">_evaluation'</span>])</span>
<span id="annotated-cell-17-110"><a href="#annotated-cell-17-110" aria-hidden="true" tabindex="-1"></a>                mlflow.end_run()</span>
<span id="annotated-cell-17-111"><a href="#annotated-cell-17-111" aria-hidden="true" tabindex="-1"></a>        </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-17-112" class="code-annotation-target"><a href="#annotated-cell-17-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">@hook_impl</span></span>
<span id="annotated-cell-17-113"><a href="#annotated-cell-17-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> after_pipeline_run(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="annotated-cell-17-114"><a href="#annotated-cell-17-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Hook implementation to end the MLflow run</span></span>
<span id="annotated-cell-17-115"><a href="#annotated-cell-17-115" aria-hidden="true" tabindex="-1"></a><span class="co">        after the Kedro pipeline finishes.</span></span>
<span id="annotated-cell-17-116"><a href="#annotated-cell-17-116" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="annotated-cell-17-117"><a href="#annotated-cell-17-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mlflow.active_run():</span>
<span id="annotated-cell-17-118"><a href="#annotated-cell-17-118" aria-hidden="true" tabindex="-1"></a>            mlflow.end_run()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-17" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-17" data-code-lines="67,68,69,70,71,72,73,74" data-code-annotation="1">Define the input schema that our model will expect during forecasting</span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-17" data-code-lines="77,78,79,80,81,82,83,84,85,86" data-code-annotation="2">Log the model under <code>/model</code> with the defined input schema and dependency requirements defined within <code>environment.yml</code></span>
</dd>
<dt data-target-cell="annotated-cell-17" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-17" data-code-lines="112,113" data-code-annotation="3">After the pipeline executes close the <code>MLFlow</code> active run</span>
</dd>
</dl>
</section>
</section>
<section id="experiment-run" class="level1">
<h1>Experiment Run</h1>
<p>Now that we have defined our <code>MLFlow</code> hook, we are ready to run an experiment! Before that though, we need to activate the hook we defined.</p>
<section id="activating-hooks" class="level2">
<h2 class="anchored" data-anchor-id="activating-hooks">Activating Hooks</h2>
<p>It is quite simple to activate a <code>Kedro</code> hook. We just need to import our hook class into <code>/src/climate_brazil/settings.py</code> and add the to the file the line:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># /src/climate_brazil/settings.py</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Hooks are executed in a Last-In-First-Out (LIFO) order.</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> climate_brazil.hooks <span class="im">import</span> ModelTrackingHooks</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>HOOKS <span class="op">=</span> (ModelTrackingHooks(),)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="executing-our-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="executing-our-pipeline">Executing our pipeline</h2>
<p>Okay, it is showtime! Letâ€™s re-build our pipeline image and run our pipeline.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode zsh code-with-copy"><code class="sourceCode zsh"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose build climate-brazil</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span> climate-brazil</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember that our pipeline service has a profile set to manual. We need to explicitly bring up the service.</p>
</div>
</div>
<p>If you checkout the <code>MLFlow</code> User Interface (UI) running on <code>localhost:5050</code>, you should see something like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="mlflow_fig1.png" class="img-fluid figure-img"></p>
<figcaption>MLFlow User Interface</figcaption>
</figure>
</div>
</section>
<section id="parameters-metrics" class="level2">
<h2 class="anchored" data-anchor-id="parameters-metrics">Parameters &amp; Metrics</h2>
<p>We can see more details about our nested runs by clicking on them in the UI. Here you can see both the parameters and metrics that we logged for the Brazilian city Belem.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="mlflow_fig2.png" class="img-fluid figure-img"></p>
<figcaption>City Specific Parameters &amp; Metrics</figcaption>
</figure>
</div>
</section>
<section id="artifacts" class="level2">
<h2 class="anchored" data-anchor-id="artifacts">Artifacts</h2>
<p>Finally, navigating to the artifacts tab in the UI we see the logged model, under <code>/model</code>, along with the expected input and some sample code to validate it produces the expected output.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="mlflow_fig3.png" class="img-fluid figure-img"></p>
<figcaption>City Specific Artifacts</figcaption>
</figure>
</div>
<p>Under the <code>/figures</code> path, we can find the model graph figure that we logged.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="mlflow_fig4.png" class="img-fluid figure-img"></p>
<figcaption>City Specific Model Graph</figcaption>
</figure>
</div>
<p>The artifacts are visible/accesible via the <code>MLFlow</code> UI, but remember that these objects are stored in our MinIO service. You can access the storage directly on <code>localhost:9001</code> and locate the objects in our default bucket:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="minio_fig1.png" class="img-fluid figure-img"></p>
<figcaption>MinIO Artifact Storage</figcaption>
</figure>
</div>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>In this post we walked through:</p>
<ul>
<li>Setting up <code>MLFlow</code> components as containerized services</li>
<li>Using <code>Kedro</code> hooks to inject additional functionality to our pipelines</li>
<li>Logging important metrics, parameters and artifacts with <code>MLFlow</code></li>
<li>Logging a custom model as an <code>MLFlow</code> model</li>
</ul>
</section>
<section id="coming-next" class="level1">
<h1>Coming Next</h1>
<p>Right now, we are training our models sequentially in a loop. This is not feesible when you have tens of thousands of cities. In the final <a href="../../posts/kedro-ray/index.html">post</a> of this series, we will walkthrough scaling our training with <code>Ray</code>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>